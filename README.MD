# MADU

<p align="center">
  <img height="100" src="https://i.imgur.com/KukPjFy.png">
</p>
<p align="center"> Projet final de Web 3 √† Hetic - Groupe 7 </p>

---


## Mise en place de l'application

On utilise le fichier `.env` pour contenir les variables d'environnement n√©cessaires √† l'ex√©cution de :
- __terraform__ pour la cr√©ation des diff√©rentes instances d'AWS
- __ansible__ pour le d√©ploiement des projets sur ces instances
- __github-actions__ pour le d√©ploiement continu lorsqu'on met √† jour le projet sur la branch __master__

Copiez le fichier `.env-example` et renommez-le `.env` et remplissez le avec les variables d'environnement.


### ‚ö†Ô∏è Attention

Pour ex√©cuter le script __terraform__, il est n√©cessaire d'avoir entr√© les variables :
- __AWS_ACCESS_KEY_ID__
- __AWS_SECRET_ACCESS_KEY__
- __SSH_PUBLIC_KEY__
- __SSH_PRIVATE_KEY__

Pour ex√©cuter le playbook __Ansible__ et pour le bon fonctionnement de l'application, toutes les variables sont n√©cessaires (√† l'exception de FRONT_URL et API_URL).

Apr√®s avoir rempli le fichier `.env`, avant d'ex√©cuter ces scripts, il faut exporter toutes les variables d‚Äôenvironnement.
```
set -a && source .env && set +a
```

Pour faire fonctionner __github-actions__, il faut encrypter le fichier `.env` avec __ansible-vault__
```
ansible-vault encrypt .env --output .env.encrypted --ask-vault-pass
```
Ajoutez ensuite le mot de passe utilis√© pour encrypter le fichier `.env` dans __VAULT_PASS__ dans les Secrets du projet Github.

---
### üß© Variables d'environnement

#### üì¶ Amazon Web Services
On utilise les __services d'Amazon__ pour cr√©er et g√©rer les diff√©rentes instances de l'application. __terraform__ et __Ansible__ ont besoin d'identifiants pour se connecter aux services d'Amazon et g√©rer ces instances.

Il est n√©cessaire de cr√©er un __utilisateur IAM__ avec les permissions :
- AmazonEC2FullAccess
- AmazonS3FullAccess

Les variables n√©cessaires sont :
- __AWS_ACCESS_KEY_ID__ : ID de cl√© d'acc√®s de l'utilisateur IAM
- __AWS_SECRET_ACCESS_KEY__ : Cl√© d'acc√®s secr√®te de l'utilisateur IAM

Pour cr√©er les instances EC2 avec terraform, une cl√© SSH est n√©cessaire :
- __SSH_PUBLIC_KEY__ : Cl√© public SSH
- __SSH_PRIVATE_KEY__ : Cl√© priv√©e SSH

Une fois les instances cr√©√©es via __terraform__, pour utiliser le Bucket S3 pour stocker les images. La variable n√©cessaire est :
- __AWS_S3_BUCKET__ : Nom du bucket S3


#### üê≥ Docker
On utilise __Docker__ pour monter diff√©rentes parties de l'application :
- un serveur API en __GraphQL__ utilisant __Prisma__ et __Mongoose__
- une Base de donn√©es __mongoDB__
- le Back-Office, d√©velopp√© en __React__, servi avec un serveur __Nginx__

Il faut cr√©er un compte __Docker Hub__ sur lequel seront stock√©s les images construites lors de l'ex√©cution des scripts __ansible__ ou __github-actions__. Les variables n√©cessaires sont :
- __DOCKER_USERNAME__ : Nom d'utilisateur du compte Docker Hub
- __DOCKER_PASSWORD__ : Mot de passe du compte Docker Hub


#### üçÉ mongoDB
On utilise __mongoDB__ pour la base de donn√©es. Les variables √† choisir sont :
- __MONGO_INITDB_ROOT_USERNAME__ : Nom d'utilisateur pour acc√©der √† la base de donn√©es
- __MONGO_INITDB_ROOT_PASSWORD__ : Mot de passe pour acc√©der √† la base de donn√©es


#### üíé Prisma
On utilise __Prisma__ ([Documentation](https://www.prisma.io/docs/)) qui permet de faire des requ√™tes de l'API vers la base de donn√©es avec une syntaxe objet. La variable √† choisir est :
- __PRISMA_SECRET__


#### üè¶ Stripe
On utilise __Stripe__ ([Documentation](https://stripe.com/docs)) pour g√©rer la facturation des entreprises. Il faut cr√©er un compte Stripe. La variable n√©cessaire est :
- __STRIPE_SECRET_KEY__ : Cl√© secr√®te du compte Stripe
- __STRIPE_EMAIL__ : Adresse email du compte Stripe
- __STRIPE_PASSWORD__ : Mot de passe du compte Stripe


#### üïµÔ∏è JSON Web Token
On utilise le __JSON Web Token__  ([Introduction](https://jwt.io/introduction/)) pour encrypter les informations de l'utilisateur n√©cessaires l'authentification au Back-office et √† l'application et autoriser les requ√™tes vers l'API. La variable √† choisir est :
- __APP_SECRET__


#### üìç Google Maps API
On utilise l'__API Google Maps__ ([Documentation](https://developers.google.com/maps/documentation)) pour obtenir les coordonn√©es GPS des entreprises et des points d'int√©r√™t √† partir de leur adresse lors de l'ajout √† base de donn√©es. Il faut un compte Google. La variable n√©cessaire √† g√©n√©rer :
- __GOOGLE_MAPS_API_KEY__ : [Pour obtenir la cl√©](https://developers.google.com/maps/documentation/javascript/get-api-key)


#### üì± Expo
On utilise __Expo__ ([Documentation](https://docs.expo.io/)) pour d√©velopper l'application en __React Native__ et pour d√©ployer l'application avec github-actions lors d'un push sur la branche master. Il faut cr√©er un compte Expo. La variable n√©cessaire est :
- __EXPO_USERNAME__ : Nom d'utilsateur Expo
- __EXPO_PASSWORD__ : Mot de passe Expo


#### üåê Noms de domaines
Si des noms de domaines particuliers sont d√©sir√©s pour l'API et le Back-office, les variables sont :
- __FRONT_URL__ : URL du back-office
- __API_URL__ : URL de l'API

---

## D√©veloppement

**Cloner le projet:**
```sh
git clone https://github.com/ShonhTan/projet-w3.git
cd projet-w3
```

**Cr√©er le fichier `.env`:**
```
ansible-vault decrypt .env.encrypted --output .env --ask-vault-pass
```
 
**D√©marrer le projet en mode d√©veloppement:**
```sh
docker-compose up
```

**Pour initialiser la base de donn√©es ou mettre √† jour les mod√®les de donn√©es prisma:**
```sh
docker-compose exec api yarn deploy 
```

**Ins√©rer des fausses donn√©es dans la base:**
```sh
docker-compose exec api node src/fixtures.js
```

## Documentation

- [API](/api)
- [Back-office](/back-office)
- [Automation](/automation)
  - [Cr√©ation du serveur AWS avec Terraform](/automation/terraform)
  - [D√©ploiement avec Ansible](/automation/ansible)
  
  
## Contributors 

- [Christella Levieux](https://www.linkedin.com/in/christella-levieux/) - Designer
- [Quentin Lenglin](https://quentinlenglin.xyz/) - Designer
- [Valentine Leroy](https://www.linkedin.com/in/valentine-leroy/) - Designer
- [Vincent Pham](https://github.com/ShonhTan) - D√©veloppeur
- [Florian Sahbi](https://github.com/FlorianSahbi) - D√©veloppeur
- [Th√©odore Yip](https://github.com/yip-theodore) - D√©veloppeur
- [Mahel Zeroual](https://github.com/M00NBOY) - D√©veloppeur

